# 1.1 Architecture Overview

**Deliverable**: System architecture design and core component specifications
**Dependencies**: Foundation for all other deliverables (1.2-1.6)
**Implementation Priority**: Phase 1 - Core Foundation
**Status**: ⚠️ This document describes the original Docker-based design. The implemented system evolved to a simpler direct-execution model. See [0-initial-design.md](0-initial-design.md) for current architecture.

## Current Implementation (v0.2.0)

The implemented architecture is a single-binary Rust application with the following components:

### Core Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                        aca Binary                           │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                   CLI Frontend                          │ │
│  │   - Argument parsing (clap)                            │ │
│  │   - Task file loading                                   │ │
│  │   - Mode selection                                      │ │
│  └─────────────────────────────────────────────────────────┘ │
│                             │                               │
│                             ▼                               │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │           Intelligent Task Parser (Optional)            │ │
│  │   - LLM-based analysis                                  │ │
│  │   - Dependency detection                                │ │
│  │   - Execution planning                                  │ │
│  └─────────────────────────────────────────────────────────┘ │
│                             │                               │
│                             ▼                               │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              Agent Integration Layer                    │ │
│  │  ┌─────────────┐  ┌──────────────┐  ┌────────────────┐ │ │
│  │  │Task Manager │  │LLM Providers │  │Session Manager │ │ │
│  │  │- Tree struct│  │- Claude CLI  │  │- Checkpoints   │ │ │
│  │  │- Scheduling │  │- Claude API  │  │- Persistence   │ │ │
│  │  │- Execution  │  │- OpenAI      │  │- Recovery      │ │ │
│  │  │- Progress   │  │- Ollama      │  │- State         │ │ │
│  │  └─────────────┘  └──────────────┘  └────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘

Working Directory Structure:
.aca/sessions/           - Per-session state and checkpoints
logs/                    - Execution logs
```

### Key Components

#### 1. CLI Frontend (`src/cli/`)
- Argument parsing with clap
- Task file loading (Markdown/TOML)
- Provider configuration
- Execution plan management

#### 2. Task Management (`src/task/`)
- Dynamic task tree
- Dependency resolution
- Intelligent scheduling
- Progress tracking
- Event system

#### 3. Session Persistence (`src/session/`)
- Atomic state persistence
- UUID-based checkpoints
- Recovery mechanisms
- State validation

#### 4. LLM Provider Abstraction (`src/llm/`)
- Unified async trait interface
- Claude CLI support (default)
- Claude API support
- OpenAI compatibility
- Local model support (Ollama)

#### 5. Claude Integration (`src/claude/`)
- CLI subprocess execution
- JSON output parsing
- Conversational state
- Message history

#### 6. Agent Integration (`src/integration.rs`)
- Task execution orchestration
- Provider coordination
- Error handling
- Result processing

### Execution Flow

1. **Initialization**
   - Parse CLI arguments
   - Load task file or execution plan
   - Initialize LLM provider
   - Set up session state

2. **Task Processing**
   - Optional: Intelligent parsing with LLM
   - Build task tree
   - Schedule tasks by priority/dependencies
   - Execute via LLM provider

3. **Persistence**
   - Continuous state checkpointing
   - Session recovery support
   - Progress tracking

### Configuration

```toml
[session]
checkpoint_interval_minutes = 30

[llm]
provider = "claude-cli"  # or "claude-api", "openai", "ollama"
model = "claude-sonnet-4-20250514"

[task_parser]
use_intelligent_parser = true
```

## Original Docker-Based Design

The sections below describe the original architectural vision with Docker containerization. This remains as a future enhancement roadmap.

### Planned Docker Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                        Host System                          │
│  ┌─────────────────┐    ┌─────────────────────────────────┐ │
│  │   CLI Frontend  │    │     Session Manager             │ │
│  │   - Parse args  │────│   - Docker lifecycle           │ │
│  │   - Task input  │    │   - Volume management          │ │
│  └─────────────────┘    └─────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                    │
                                    │ Docker API
                                    ▼
┌─────────────────────────────────────────────────────────────┐
│                    Docker Container                         │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                 Agent Runtime                           │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐ │ │
│  │  │Task Manager │  │LLM Provider │  │Session Context  │ │ │
│  │  │- Task tree  │  │Interface    │  │- Conversation   │ │ │
│  │  │- Scheduler  │  │- Multiple   │  │- File changes   │ │ │
│  │  │- State mgmt │  │  providers  │  │- Build state    │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                             │
│  Volume Mounts:                                             │
│  /repos     (RO) - Source repositories                      │
│  /workspace (RW) - Working directory                        │
│  .aca/      (RW) - Persistent session data                  │
│  /logs      (RW) - Execution logs                           │
└─────────────────────────────────────────────────────────────┘
```

### Future Enhancements

- Docker containerization for isolation
- Multi-container distributed execution
- Resource limits (CPU, memory)
- Read-only repository mounts
- Headless Claude Code SDK integration
- WebSocket-based provider communication
- Web dashboard for monitoring
- Plugin system for extensibility

---

**Note**: For the current implementation details, refer to:
- [0-initial-design.md](0-initial-design.md) - Current architecture and features
- Source code in `src/` directory
- [CHANGELOG.md](../../CHANGELOG.md) - Implementation history
